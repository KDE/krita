From ce15361bb0f077267454216a8e7e0ccfa6b56020 Mon Sep 17 00:00:00 2001
From: Boudewijn Rempt <boud@valdyas.org>
Date: Mon, 23 Jul 2018 12:04:52 +0200
Subject: [PATCH 8/8] macdeploy-qt.diff

---
 qttools/src/macdeployqt/macdeployqt/main.cpp | 16 ++++++-
 qttools/src/macdeployqt/shared/shared.cpp    | 47 ++++++++++++++++++++
 qttools/src/macdeployqt/shared/shared.h      |  1 +
 3 files changed, 62 insertions(+), 2 deletions(-)

diff --git a/qttools/src/macdeployqt/macdeployqt/main.cpp b/qttools/src/macdeployqt/macdeployqt/main.cpp
index 90a5412b2..537af266b 100644
--- a/qttools/src/macdeployqt/macdeployqt/main.cpp
+++ b/qttools/src/macdeployqt/macdeployqt/main.cpp
@@ -54,6 +54,7 @@ int main(int argc, char **argv)
         qDebug() << "   -appstore-compliant: Skip deployment of components that use private API";
         qDebug() << "   -libpath=<path>    : Add the given path to the library search path";
         qDebug() << "   -fs=<filesystem>   : Set the filesystem used for the .dmg disk image (defaults to HFS+)";
+        qDebug() << "   -extra-plugins=<d> : Deploy plugins from given extra directory";
         qDebug() << "";
         qDebug() << "macdeployqt takes an application bundle as input and makes it";
         qDebug() << "self-contained by copying in the Qt frameworks and plugins that";
@@ -96,6 +97,7 @@ int main(int argc, char **argv)
     extern QString codesignIdentiy;
     extern bool appstoreCompliant;
     extern bool deployFramework;
+    QStringList extraPluginDirectories;
 
     for (int i = 2; i < argc; ++i) {
         QByteArray argument = QByteArray(argv[i]);
@@ -171,6 +173,13 @@ int main(int argc, char **argv)
                 LogError() << "Missing filesystem type";
             else
                 filesystem = argument.mid(index+1);
+         } else if (argument.startsWith(QByteArray("-extra-plugins"))) {
+             LogDebug() << "Argument found:" << argument;
+             int index = argument.indexOf('=');
+             if (index == -1)
+                 LogError() << "Missing extra plugins directory";
+             else
+                 extraPluginDirectories << argument.mid(index+1);
         } else if (argument.startsWith("-")) {
             LogError() << "Unknown argument" << argument << "\n";
             return 1;
@@ -201,10 +210,13 @@ int main(int argc, char **argv)
         deploymentInfo.deployedFrameworks = deploymentInfo.deployedFrameworks.toSet().toList();
     }
 
-    if (plugins && !deploymentInfo.qtPath.isEmpty()) {
+    if ((plugins && !deploymentInfo.qtPath.isEmpty()) || !extraPluginDirectories.isEmpty()) {
         deploymentInfo.pluginPath = deploymentInfo.qtPath + "/plugins";
         LogNormal();
-        deployPlugins(appBundlePath, deploymentInfo, useDebugLibs);
+        if (plugins && !deploymentInfo.qtPath.isEmpty())
+            deployPlugins(appBundlePath, deploymentInfo, useDebugLibs);
+        if (!extraPluginDirectories.isEmpty())
+            deployExtraPlugins(appBundlePath, deploymentInfo, useDebugLibs, extraPluginDirectories);
         createQtConf(appBundlePath);
     }
 
diff --git a/qttools/src/macdeployqt/shared/shared.cpp b/qttools/src/macdeployqt/shared/shared.cpp
index bef3543dc..0e57d9063 100644
--- a/qttools/src/macdeployqt/shared/shared.cpp
+++ b/qttools/src/macdeployqt/shared/shared.cpp
@@ -1130,6 +1130,43 @@ void deployPlugins(const ApplicationBundleInfo &appBundleInfo, const QString &pl
     }
 }
 
+void deployExtraPlugins(const ApplicationBundleInfo &appBundleInfo,
+        const QString pluginDestinationPath, DeploymentInfo deploymentInfo, bool useDebugLibs, const QStringList &extraPluginDirectories)
+{
+    foreach (const QString &extraPluginDir, extraPluginDirectories) {
+        LogNormal() << "Deploying plugins from" << extraPluginDir;
+
+        // search for dylib and so files, both work as plugins on mac os
+        QDir dir(extraPluginDir);
+        dir.setFilter(QDir::Files);
+        dir.setNameFilters(QStringList() << "*.dylib" << "*.so");
+        QDirIterator dirIterator(dir, QDirIterator::Subdirectories);
+        QStringList pluginList;
+        while (dirIterator.hasNext()) {
+            dirIterator.next();
+            if (!QFileInfo(dirIterator.filePath()).isFile())
+                continue;
+            pluginList.append(dir.relativeFilePath(dirIterator.filePath()));
+        }
+
+        // deploy all found plugins
+        foreach (const QString &plugin, pluginList) {
+            QString sourcePath = extraPluginDir + "/" + plugin;
+            const QString destinationPath = pluginDestinationPath + "/" + plugin;
+            QDir dir;
+            dir.mkpath(QFileInfo(destinationPath).path());
+
+            if (copyFilePrintStatus(sourcePath, destinationPath)) {
+                runStrip(destinationPath);
+
+                QList<FrameworkInfo> frameworks = getQtFrameworks(destinationPath, appBundleInfo.path, deploymentInfo.rpathsUsed, useDebugLibs);
+                deployQtFrameworks(frameworks, appBundleInfo.path, QStringList() << destinationPath, useDebugLibs, deploymentInfo.useLoaderPath);
+
+            }
+        }
+    }
+}
+
 void createQtConf(const QString &appBundlePath)
 {
     // Set Plugins and imports paths. These are relative to App.app/Contents.
@@ -1171,6 +1208,16 @@ void deployPlugins(const QString &appBundlePath, DeploymentInfo deploymentInfo,
     deployPlugins(applicationBundle, deploymentInfo.pluginPath, pluginDestinationPath, deploymentInfo, useDebugLibs);
 }
 
+void deployExtraPlugins(const QString &appBundlePath, DeploymentInfo deploymentInfo, bool useDebugLibs, const QStringList &extraPluginDirectories)
+{
+    ApplicationBundleInfo applicationBundle;
+    applicationBundle.path = appBundlePath;
+    applicationBundle.binaryPath = findAppBinary(appBundlePath);
+
+    const QString pluginDestinationPath = appBundlePath + "/" + "Contents/PlugIns";
+    deployExtraPlugins(applicationBundle, pluginDestinationPath, deploymentInfo, useDebugLibs, extraPluginDirectories);
+}
+
 void deployQmlImport(const QString &appBundlePath, const QSet<QString> &rpaths, const QString &importSourcePath, const QString &importName)
 {
     QString importDestinationPath = appBundlePath + "/Contents/Resources/qml/" + importName;
diff --git a/qttools/src/macdeployqt/shared/shared.h b/qttools/src/macdeployqt/shared/shared.h
index c4d60ea0a..0b8d576fe 100644
--- a/qttools/src/macdeployqt/shared/shared.h
+++ b/qttools/src/macdeployqt/shared/shared.h
@@ -116,6 +116,7 @@ DeploymentInfo deployQtFrameworks(const QString &appBundlePath, const QStringLis
 DeploymentInfo deployQtFrameworks(QList<FrameworkInfo> frameworks,const QString &bundlePath, const QStringList &binaryPaths, bool useDebugLibs, bool useLoaderPath);
 void createQtConf(const QString &appBundlePath);
 void deployPlugins(const QString &appBundlePath, DeploymentInfo deploymentInfo, bool useDebugLibs);
+void deployExtraPlugins(const QString &appBundlePath, DeploymentInfo deploymentInfo, bool useDebugLibs, const QStringList &extraPluginDirectories);
 bool deployQmlImports(const QString &appBundlePath, DeploymentInfo deploymentInfo, QStringList &qmlDirs);
 void changeIdentification(const QString &id, const QString &binaryPath);
 void changeInstallName(const QString &oldName, const QString &newName, const QString &binaryPath);
-- 
2.17.1

